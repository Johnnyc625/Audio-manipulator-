let soundFile;
let fileInput;
let playButton, stopButton;
let volSlider;

let isSoundLoaded = false;
let instructions = "Load an audio file (WAV, MP3, OGG)";

function setup() {
  createCanvas(400, 300);
  background(200);
  textAlign(CENTER, CENTER);

  // --- UI Elements ---
  fileInput = createFileInput(handleFile);
  fileInput.position(20, 30);

  playButton = createButton('Play');
  playButton.position(20, 70);
  playButton.mousePressed(playAudio);
  playButton.attribute('disabled', '');

  stopButton = createButton('Stop');
  stopButton.position(80, 70);
  stopButton.mousePressed(stopAudio);
  stopButton.attribute('disabled', '');

  volSlider = createSlider(0, 1, 0.5, 0.01);
  volSlider.position(20, 120);
  volSlider.input(updateVolume);
  // todo: Add label for the volume slider
}

function draw() {
  background(200);

  // Display status text
  fill(0);
  textSize(14);
  text(instructions, width / 2, 180);

  // todo: add simple visualization later?
  // if (isSoundLoaded && soundFile.isPlaying()) {
  //   let level = soundFile.getLevel(); // Need an Amplitude object
  //   ellipse(width/2, height - 50, level * 100, level * 100);
  // }
}

// --- Audio Loading ---
function handleFile(file) {
  print("Attempting to load:", file.name);
  if (file.type === 'audio') {
    if (soundFile) {
      soundFile.stop(); // Stop previous sound
    }
    isSoundLoaded = false;
    playButton.attribute('disabled', '');
    stopButton.attribute('disabled', '');
    instructions = "Loading: " + file.name;

    // Load the new sound file
    soundFile = loadSound(file, soundLoadedCallback);

  } else {
    instructions = "Please select an audio file.";
    console.log("Not an audio file!");
  }
}

function soundLoadedCallback() {
  console.log("Sound loaded!");
  isSoundLoaded = true;
  instructions = "Loaded: " + soundFile.file.name;

  // Enable controls
  playButton.removeAttribute('disabled');
  stopButton.removeAttribute('disabled');

  updateVolume(); // Apply initial volume

  // todo: add error handling for failed loads
}

// --- Playback Controls ---
function playAudio() {
  if (isSoundLoaded && !soundFile.isPlaying()) {
    soundFile.play();
    console.log("Playing");
    // todo: maybe change button text to "Pause"
  }
}

function stopAudio() {
  if (isSoundLoaded) {
    soundFile.stop();
    console.log("Stopped");
  }
}

// --- Audio Manipulation ---
function updateVolume() {
  if (isSoundLoaded) {
    soundFile.setVolume(volSlider.value());
  }
}

// todo: implement Rate/Speed control slider
// todo: implement basic Filter effect
// todo: implement Reverse button
// todo: add progress bar/display
